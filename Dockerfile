FROM rust:1.62-alpine3.15 as builder
WORKDIR /app

RUN apk --no-cache update &&\
    apk --no-cache add musl-dev openssl-dev

RUN cargo install --locked trunk
RUN rustup target add wasm32-unknown-unknown

COPY . .
# build the shared types
RUN cd cve-audit-types &&\
    cargo build --release &&\
    cd ..
# build the ui
RUN cd cve-audit-ui &&\
    trunk build --release &&\
    cd ..
# build the suma-cve-audit-tool binary
RUN cargo build --release

FROM alpine:latest
COPY --from=builder /app/target/release/suma-cve-audit-tool /
EXPOSE 8081
CMD [ "/suma-cve-audit-tool" ]